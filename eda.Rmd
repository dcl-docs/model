
# EDA

```{r message=FALSE, warning=FALSE, echo=FALSE}
# Libraries
library(tidyverse)
```

The `diamonds` dataset, in the ggplot2 package, contains information on round `r nrow(diamonds)` diamonds from the [Loose Diamonds Search Engine](https://www.diamondse.info). 

```{r echo=FALSE}
diamonds %>% 
  head() %>% 
  knitr::kable()
```

Each row of `diamonds` represents a single diamond, and contains data on that diamond's features and price. It would be interesting to understand the relationship between the features of a diamond and it's price. 

In this chapter, we're going to do the necessary exploratory data analysis that comes before you're even thinking about what kind of model to build. We'll look at a high-level summary of the data, understand our variables, look for errors and outliers, and restrict our data to where most of the diamonds are. 

Diamonds have a set of features called the "Four C's": `carat`, `cut`, `clarity`, and `color`. 


## Understand your variables

First, before visualizing or even looking at your data, try to understand the your variables measure. Because `diamonds` is built into ggplot2, you take a look at the diamonds help page (`?diamonds`) to see some documentation. 

Diamonds have a set of features called the "Four C's": `carat`, `cut`, `clarity`, and `color`. `diamonds` includes these four features, as well as information on diamond price and dimension.

`carat` measures the weight of each diamond in carats. One carat is equivalent to 0.2 grams. For reference, a dollar bill weighs around 1 gram. 

`cut` refers to how a rough diamond is shaped into a finished diamond. Better cuts create more symmetrical and luminous diamonds. `cut` has 5 ordered levels: "Fair", "Good", "Very Good", "Premium", "Ideal".

`color` refers to the color of the diamond. Colorless diamonds are considered better than diamonds with a yellow tint. `diamonds` contains diamonds of 7 different colors. "D" - "F" diamonds are considered colorless, while "G" - "J" diamonds have a very faint color.

`clarity` refers to how clear a diamond is. Diamonds often contain imperfections like cracks or mineral desposits. The fewer and less noticeable these imperfections, the better a diamond's clarity. `clarity` contains 8 ordered levels, from "I1" (the worst) to "IF" (the best).

`x`, `y`, `z`, `depth`, and `table` are various measures of a diamonds size. 

## Summary

Now that we understand what the variables mean, we can dig into the data. `summary()` is a good place to start.

```{r}
summary(diamonds)
```

Notice that there are some diamonds with "0.0" for `x`, `y`, or `z`, which is impossible. Let's see how many impossible diamonds are in our data.

```{r}
diamonds %>% 
  filter(x == 0 | y == 0 | z == 0) %>% 
  nrow()
```

There are only 20, so we'll remove them.

```{r}
df <-
  diamonds %>% 
  filter(x > 0, y > 0, z > 0)
```

## Outliers

### `x`, `y`, and `z`

Now, it's time to look at outliers. Checking for outliers is an important step in the EDA before you build your model. As you saw in chapter 1, even a single outlier can throw off a model. 

First, we'll look for outliers in `x`, `y`, and `z`. From the summary, you can see that these variables have some values much larger than the rest.

```{r  echo=FALSE}
diamonds_boxplot <- function(data, var) {
  data %>% 
    ggplot(mapping = aes(x = factor(1), y = {{var}})) +
    geom_boxplot() +
    scale_x_discrete(breaks = NULL, labels = NULL) +
    coord_flip() +
    labs(x = NULL, title = quo({{var}})) 
}

diamonds_boxplot(df, x)
```

The outliers for `x` don't look too extreme. 

```{r echo=FALSE}
diamonds_boxplot(df, y)
```

```{r echo=FALSE}
diamonds_boxplot(df, z)
```

There appear to be some large outliers for `y` and `z`. We'll remove these diamonds, as there are only 3.

```{r}
df <-
  df %>% 
  filter(y < 20, z < 10)
```


### `carat`

The range of `carat` values is also large.

```{r}
df %>% 
  ggplot(aes(carat)) +
  geom_histogram(binwidth = 0.01)
```

From the histogram, you can tell that almost all dimonds are under 3 carats. There might not be enough data to model the carats larger than that, so we'll restrict our attention to just the 99% of carats by calculating the 99th quantile, which is `r quantile(diamonds$carat, probs = 0.99).

```{r}
df <-
  df %>% 
  filter(carat <= quantile(df$carat, probs = 0.99))
```

We removed 512 diamonds. 

## Carat and price

In the next chapter, we'll explicitly visualize the relationship between carat and price to understand the functional form of the relationship. For now, let's just make histograms of the two variables and see which conclusions we can draw.

```{r}
df %>% 
  ggplot(mapping = aes(x = carat)) +
  geom_histogram(binwidth = 0.01) +
  scale_x_continuous(breaks = seq(0.2, 2.2, 0.1), minor_breaks = NULL)
```

Notice how spiky the `carat` distribution is. There are peaks at many of the tenth of a carat marks, suggesting that diamonds are often rounded to the tenth of a carat.

Now, let's look at price.

```{r}
df %>% 
  ggplot(aes(price)) +
  geom_histogram(binwidth = 50)
```

Again, we see a distribution with a long tail. Interestingly, there's a gap in the distribution around $1500. There are no diamonds priced between $1455 and 1545, probably caused by an error importing the data. 

One thing we can see right away is that the `price` distribution does not follow the same spiky pattern as the `carat` distribution, suggesting that `price` is not just a function of carat. 

### `clarity`, `color`, and `cut`

Now, we can look at the other 3 C's: `clarity`, `cut`, and `color`, all discrete variables. 

reorder
```{r}
diamonds <-
  diamonds %>%
  mutate(color = fct_rev(color))
```


